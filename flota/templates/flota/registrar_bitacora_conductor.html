{% extends 'base.html' %}
{% load static %}

{% block title %}Registrar Salida - Conductor{% endblock %}

{% block extra_css %}
<style>
    .form-paso {
        display: none;
        animation: fadeIn 0.4s ease-in-out;
        padding: 25px;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        margin-bottom: 20px;
        border-top: 5px solid #0d6efd;
    }
    
    .form-paso.activo {
        display: block;
    }
    
    .paso-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #f0f0f0;
    }

    .paso-titulo { font-size: 1.3rem; font-weight: 600; color: #2c3e50; }
    .paso-titulo i { color: #0d6efd; margin-right: 10px; }
    .paso-indicador { background: #e9ecef; color: #495057; padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; }
    
    /* Barra de progreso */
    .progreso-container { margin-bottom: 2rem; padding: 0 10px; }
    .progreso-bar { width: 100%; height: 10px; background-color: #e9ecef; border-radius: 5px; overflow: hidden; margin-bottom: 8px; }
    .progreso-fill { height: 100%; background: linear-gradient(90deg, #0d6efd, #0dcaf0); border-radius: 5px; transition: width 0.4s ease; width: 0%; }
    .progreso-texto { text-align: right; font-size: 0.85rem; color: #6c757d; font-weight: 600; }

    /* Validaciones */
    .campo-invalido { border-color: #dc3545 !important; background-color: #fff8f8 !important; }
    .error-mensaje { color: #dc3545; font-size: 0.85em; margin-top: 4px; display: none; }
    .error-mensaje.mostrar { display: block; animation: slideDown 0.2s; }

    /* Botones */
    .nav-pasos { display: flex; justify-content: space-between; margin-top: 2rem; padding: 1rem; background: #fff; border-radius: 12px; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }

    @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
{% endblock %}

{% block content %}
<div class="container py-3">
    <h2 class="mb-4 text-primary"><i class="bi bi-steering-wheel"></i> Registrar Nueva Salida</h2>

    <div class="progreso-container">
        <div class="progreso-bar">
            <div class="progreso-fill" id="progreso-fill"></div>
        </div>
        <div class="progreso-texto" id="progreso-texto">Paso 1 de 6</div>
    </div>

    <form method="post" id="form-pasos" novalidate>
        {% csrf_token %}
        
        <div class="form-paso activo" id="paso-1" data-titulo="Datos del Vehículo">
            <div class="paso-header">
                <div class="paso-titulo"><i class="bi bi-car-front-fill"></i> Vehículo y Turno</div>
                <div class="paso-indicador">Paso 1</div>
            </div>
            <div class="row g-3">
                <div class="col-md-12">
                    <label for="id_vehiculo" class="form-label">Vehículo *</label>
                    <select name="vehiculo" id="id_vehiculo" class="form-select form-select-lg" required>
                        <option value="">Seleccione el vehículo...</option>
                        {% for vehiculo in form.vehiculo.field.queryset %}
                            <option value="{{ vehiculo.pk }}">{{ vehiculo.patente }} - {{ vehiculo.marca }} {{ vehiculo.modelo }}</option>
                        {% endfor %}
                    </select>
                    <div class="error-mensaje" id="error-vehiculo">Debe seleccionar un vehículo</div>
                </div>
                <div class="col-md-6">
                    <label for="id_fecha" class="form-label">Fecha *</label>
                    <input type="date" name="fecha" id="id_fecha" class="form-control" value="{% now 'Y-m-d' %}" required>
                </div>
                <div class="col-md-6">
                    <label for="id_turno" class="form-label">Turno *</label>
                    <select name="turno" id="id_turno" class="form-select" required>
                        <option value="">Seleccione turno...</option>
                        {% for value, label in form.turno.field.choices %}
                            {% if value != "" %}<option value="{{ value }}">{{ label }}</option>{% endif %}
                        {% endfor %}
                    </select>
                    <div class="error-mensaje" id="error-turno">Seleccione un turno</div>
                </div>
            </div>
        </div>

        <div class="form-paso" id="paso-2" data-titulo="Personal Médico">
            <div class="paso-header">
                <div class="paso-titulo"><i class="bi bi-people-fill"></i> Equipo Médico</div>
                <div class="paso-indicador">Paso 2</div>
            </div>
            <div class="alert alert-light border">
                <small class="text-muted"><i class="bi bi-info-circle"></i> Deje en blanco si no aplica.</small>
            </div>
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Médico</label>
                    {{ form.medico }} </div>
                <div class="col-md-6">
                    <label class="form-label">Enfermero/a</label>
                    {{ form.enfermero }}
                </div>
                <div class="col-md-6">
                    <label class="form-label">TENS</label>
                    {{ form.tens }}
                </div>
                <div class="col-md-6">
                    <label class="form-label">Camillero</label>
                    {{ form.camillero }}
                </div>
            </div>
        </div>

        <div class="form-paso" id="paso-3" data-titulo="Detalle del Viaje">
            <div class="paso-header">
                <div class="paso-titulo"><i class="bi bi-geo-alt-fill"></i> Destino y Paciente</div>
                <div class="paso-indicador">Paso 3</div>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Hora Salida *</label>
                <input type="time" name="hora_salida" id="id_hora_salida" class="form-control" required>
                <div class="error-mensaje" id="error-hora_salida">Ingrese la hora de salida</div>
            </div>

            <div class="mb-3">
                <label class="form-label">Destino / Lugar *</label>
                {{ form_viaje.destino }} <div class="error-mensaje" id="error-destino">Ingrese el destino</div>
            </div>

            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Paciente (Nombre)</label>
                    {{ form_viaje.nombre_paciente }}
                </div>
                <div class="col-md-6">
                    <label class="form-label">RUT Paciente</label>
                    {{ form_viaje.rut_paciente }}
                </div>
                <div class="col-12">
                    <label class="form-label">Tipo de Servicio *</label>
                    {{ form_viaje.tipo_servicio }}
                </div>
            </div>
        </div>

        <div class="form-paso" id="paso-4" data-titulo="Control de Kilometraje">
            <div class="paso-header">
                <div class="paso-titulo"><i class="bi bi-speedometer"></i> Cierre de Viaje</div>
                <div class="paso-indicador">Paso 4</div>
            </div>
            
            <div class="alert alert-info py-2">
                <i class="bi bi-info-circle-fill me-2"></i>
                <strong>KM Actual Vehículo:</strong> <span id="span-km-actual" class="fw-bold">---</span>
            </div>
        
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label fw-bold">KM Salida (Inicio) *</label>
                    <input type="number" name="km_inicio_viaje" id="id_km_inicio_viaje" class="form-control form-control-lg" required>
                    <div class="error-mensaje" id="error-km_inicio_viaje">KM inicial requerido</div>
                </div>
                
                <div class="col-md-6">
                    <label class="form-label fw-bold">KM Llegada (Fin) *</label>
                    <input type="number" name="km_fin_viaje" id="id_km_fin_viaje" class="form-control form-control-lg" required>
                    <small class="text-success fw-bold d-block mt-1" id="kms-recorridos-calc">Recorridos: 0 km</small>
                    <div class="error-mensaje" id="error-km_fin_viaje">El KM final debe ser mayor al inicial</div>
                </div>
                
                <div class="col-12"><hr class="text-muted"></div>
        
                <div class="col-md-6">
                    <label class="form-label fw-bold">Hora de Llegada *</label>
                    <input type="time" name="hora_llegada" id="id_hora_llegada" class="form-control form-control-lg" required>
                    <div class="error-mensaje" id="error-hora_llegada">Ingrese la hora de llegada</div>
                </div>
                
                <div class="col-md-6">
                    <label class="form-label text-muted">Hora de Salida (Registrada en Paso 3)</label>
                    <input type="time" id="visual_hora_salida" class="form-control bg-light" disabled>
                </div>
            </div>
        </div>

        <div class="form-paso" id="paso-5" data-titulo="Observaciones">
            <div class="paso-header">
                <div class="paso-titulo"><i class="bi bi-chat-text-fill"></i> Observaciones</div>
                <div class="paso-indicador">Paso 5</div>
            </div>
            <div class="mb-3">
                <label class="form-label">Comentarios generales de la salida</label>
                {{ form.observaciones }}
            </div>
        </div>

        <div class="form-paso" id="paso-6" data-titulo="Confirmar">
            <div class="paso-header">
                <div class="paso-titulo"><i class="bi bi-check-circle-fill"></i> Resumen</div>
                <div class="paso-indicador">Paso 6</div>
            </div>
            
            <div class="card bg-light border-0">
                <div class="card-body" id="resumen-contenido">
                    </div>
            </div>
            
            <div class="form-check mt-3">
                <input class="form-check-input" type="checkbox" id="check-confirmacion" required>
                <label class="form-check-label" for="check-confirmacion">
                    Declaro que los datos ingresados son verídicos.
                </label>
                <div class="error-mensaje" id="error-confirmacion">Debe confirmar para guardar.</div>
            </div>
        </div>

        <div class="nav-pasos">
            <button type="button" id="btn-anterior" class="btn btn-outline-secondary px-4" disabled>
                <i class="bi bi-arrow-left"></i> Anterior
            </button>
            
            <div>
                <a href="{% url 'listar_bitacoras' %}" class="btn btn-link text-decoration-none text-muted me-2">Cancelar</a>
                <button type="button" id="btn-siguiente" class="btn btn-primary px-4">
                    Siguiente <i class="bi bi-arrow-right"></i>
                </button>
                <button type="submit" id="btn-enviar" class="btn btn-success px-4" style="display: none;">
                    <i class="bi bi-save"></i> Registrar Salida
                </button>
            </div>
        </div>

        <div class="d-none">
            <input type="number" name="km_inicio" id="hidden_km_inicio_hoja">
            <input type="number" name="km_fin" id="hidden_km_fin_hoja">
        </div>

    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/registrar_bitacora_conductor.js' %}"></script>
{% endblock %}
