{% extends 'base.html' %}

{% load static %}

{% block title %}Reportes - Gestión de Flota{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'js/reporte_costos.js' %}"></script>
<script>
    // 1. Obtener datos desde Django
    const datosGraficos = {{ graficos_json|safe }};
    
    console.log('=== DIAGNÓSTICO DE DATOS ===');
    console.log('Patentes:', datosGraficos.patentes);
    console.log('Costos Mantenimiento:', datosGraficos.costos_mantenimiento);
    console.log('Costos Combustible:', datosGraficos.costos_combustible);
    console.log('Costos Arriendo:', datosGraficos.costos_arriendo);
    
    // Esperar a que el DOM esté completamente cargado
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM cargado, creando gráficos...');
        
        // 2. Gráfico de Costos por Vehículo (Barras Apiladas)
        const ctxCostos = document.getElementById('chartCostosPorVehiculo');
        if (ctxCostos) {
            console.log('Creando gráfico de costos...');
            const chartCostos = new Chart(ctxCostos, {
                type: 'bar',
                data: {
                    labels: datosGraficos.patentes,
                    datasets: [
                        {
                            label: 'Mantenimiento',
                            data: datosGraficos.costos_mantenimiento,
                            backgroundColor: 'rgba(255, 99, 132, 0.8)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Combustible',
                            data: datosGraficos.costos_combustible,
                            backgroundColor: 'rgba(54, 162, 235, 0.8)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Arriendo',
                            data: datosGraficos.costos_arriendo,
                            backgroundColor: 'rgba(255, 206, 86, 0.8)',
                            borderColor: 'rgba(255, 206, 86, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: { 
                            display: true, 
                            text: 'Costos Totales por Vehículo',
                            font: { size: 16 }
                        },
                        tooltip: { 
                            mode: 'index', 
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += '$' + context.parsed.y.toLocaleString('es-CL');
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { 
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Vehículos'
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            title: { 
                                display: true, 
                                text: 'Costo ($)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('es-CL');
                                }
                            }
                        }
                    },
                    // Interactividad: Al hacer clic en una barra
                    onClick: (evt, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            console.log('Clic en vehículo:', datosGraficos.patentes[index]);
                            actualizarDesgloseCostos(index);
                        }
                    }
                }
            });
        } else {
            console.error('No se encontró el canvas para gráfico de costos');
        }
    
        // 3. Gráfico de Días Fuera de Servicio
        const ctxDias = document.getElementById('chartDiasFueraServicio');
        if (ctxDias) {
            console.log('Creando gráfico de días fuera de servicio...');
            const chartDias = new Chart(ctxDias, {
                type: 'bar',
                data: {
                    labels: datosGraficos.patentes,
                    datasets: [{
                        label: 'Días fuera de servicio',
                        data: datosGraficos.dias_fuera_servicio,
                        backgroundColor: 'rgba(153, 102, 255, 0.8)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y', // Barras horizontales
                    responsive: true,
                    plugins: {
                        title: { 
                            display: true, 
                            text: 'Días Fuera de Servicio por Vehículo',
                            font: { size: 16 }
                        }
                    },
                    scales: {
                        x: { 
                            beginAtZero: true, 
                            title: { 
                                display: true, 
                                text: 'Días' 
                            }
                        }
                    }
                }
            });
        }
    
        // 4. Gráfico de Desglose (Dona)
        let chartDesglose = null;
        
        function actualizarDesgloseCostos(indexVehiculo) {
            console.log('Actualizando desglose para índice:', indexVehiculo);
            
            const canvas = document.getElementById('chartDesgloseCostos');
            if (!canvas) {
                console.error('No se encontró el canvas para desglose');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            
            // Datos para este vehículo específico
            const datos = [
                datosGraficos.costos_mantenimiento[indexVehiculo] || 0,
                datosGraficos.costos_combustible[indexVehiculo] || 0,
                datosGraficos.costos_arriendo[indexVehiculo] || 0
            ];
            
            console.log('Datos para desglose:', datos);
            
            // Verificar si hay datos
            const total = datos.reduce((a, b) => a + b, 0);
            console.log('Total de costos:', total);
            
            // Destruir gráfico anterior si existe
            if (chartDesglose) {
                chartDesglose.destroy();
            }
            
            if (total === 0) {
                // Mostrar mensaje de "sin datos"
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#f5f5f5';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.fillStyle = '#999';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('No hay datos de costos', canvas.width / 2, canvas.height / 2 - 10);
                ctx.fillText('para este vehículo', canvas.width / 2, canvas.height / 2 + 10);
                return;
            }
            
            // Crear el gráfico de desglose
            chartDesglose = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Mantenimiento', 'Combustible', 'Arriendo'],
                    datasets: [{
                        data: datos,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(54, 162, 235, 0.8)', 
                            'rgba(255, 206, 86, 0.8)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    cutout: '60%', // Hace el "agujero" más grande
                    plugins: {
                        title: {
                            display: true,
                            text: `Desglose: ${datosGraficos.patentes[indexVehiculo]}`,
                            font: { size: 14 }
                        },
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${context.label}: $${value.toLocaleString('es-CL')} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            console.log('Gráfico de desglose creado');
        }
        
        // Inicializar con el primer vehículo que tenga datos
        let indiceInicial = 0;
        for (let i = 0; i < datosGraficos.patentes.length; i++) {
            const total = (datosGraficos.costos_mantenimiento[i] || 0) + 
                         (datosGraficos.costos_combustible[i] || 0) + 
                         (datosGraficos.costos_arriendo[i] || 0);
            if (total > 0) {
                indiceInicial = i;
                break;
            }
        }
        
        console.log('Inicializando desglose con índice:', indiceInicial);
        actualizarDesgloseCostos(indiceInicial);
    });
</script>
{% endblock %}

{% block content %}
<h2 class="mb-4"><i class="bi bi-graph-up"></i> Reportes</h2>

<ul class="nav nav-tabs mb-4" id="reportesTab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link {% if active_tab == 'costos' %}active{% endif %}" 
                id="costos-tab" 
                data-bs-toggle="tab" 
                data-bs-target="#costos" 
                type="button" 
                role="tab">
            <i class="bi bi-cash-coin"></i> Costos
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link {% if active_tab == 'variacion' %}active{% endif %}" 
                id="variacion-tab" 
                data-bs-toggle="tab" 
                data-bs-target="#variacion" 
                type="button" 
                role="tab">
            <i class="bi bi-cash-stack"></i> Variación Presupuestaria
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link {% if active_tab == 'dashboard' %}active{% endif %}"
                id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard"
                type="button" role="tab">
            <i class="bi bi-bar-chart-line"></i> Dashboard
        </button>
    </li>
</ul>


<div class="tab-content" id="reportesTabContent">
    <!-- Tab Costos -->
    <div class="tab-pane fade {% if active_tab == 'costos' %}show active{% endif %}" 
         id="costos" 
         role="tabpanel">
        <div class="mb-3">
            <a href="?exportar=excel&tab=costos" class="btn btn-success">
                <i class="bi bi-file-earmark-excel"></i> Exportar a Excel
            </a>
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Vehículo</th>
                        <th>Costo Mantenimientos</th>
                        <th>Costo Combustible</th>
                        <th>Costo Arriendos</th>
                        <th>Costo Total</th>
                        <th>Costo por Km</th>
                        <th>Presupuesto</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in reporte %}
                    <tr>
                        <td><strong>{{ item.vehiculo.patente }}</strong></td>
                        <td>${{ item.costo_mantenimientos|floatformat:0 }}</td>
                        <td>${{ item.costo_combustible|floatformat:0 }}</td>
                        <td>${{ item.costo_arriendos|floatformat:0 }}</td>
                        <td><strong>${{ item.costo_total|floatformat:0 }}</strong></td>
                        <td>${{ item.costo_por_km|floatformat:2 }}</td>
                        <td>${{ item.presupuesto|floatformat:0 }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center">No hay datos disponibles.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Tab Variación Presupuestaria -->
    <div class="tab-pane fade {% if active_tab == 'variacion' %}show active{% endif %}" 
         id="variacion" 
         role="tabpanel">
        <form method="get" class="mb-3">
            <div class="row">
                <div class="col-md-4">
                    <label>Año</label>
                    <select name="anio" class="form-control">
                        {% for anio_opcion in anios_disponibles %}
                        <option value="{{ anio_opcion }}" {% if anio_opcion == anio %}selected{% endif %}>
                            {{ anio_opcion }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <input type="hidden" name="tab" value="variacion">
                <div class="col-md-4">
                    <label>&nbsp;</label><br>
                    <button type="submit" class="btn btn-primary">Filtrar</button>
                </div>
            </div>
        </form>
        
        <div class="mb-3">
            <a href="?exportar=excel&tipo=variacion&anio={{ anio }}&tab=variacion" class="btn btn-success">
                <i class="bi bi-file-earmark-excel"></i> Exportar a Excel
            </a>
        </div>
        
        {% if alertas_variacion %}
        <div class="alert alert-danger">
            <strong><i class="bi bi-exclamation-triangle"></i> {{ alertas_variacion|length }} alerta(s) de sobrepaso presupuestario >10%</strong>
            <p>Los siguientes presupuestos han sido excedidos en más del 10% del monto planificado.</p>
        </div>
        {% endif %}
        
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Vehículo</th>
                        <th>Cuenta SIGFE</th>
                        <th>Monto Asignado</th>
                        <th>Monto Ejecutado</th>
                        <th>Diferencia</th>
                        <th>% Variación</th>
                        <th>% Ejecutado</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in reporte_variacion %}
                    <tr {% if item.tiene_alerta %}class="table-warning"{% endif %}>
                        <td><strong>{{ item.vehiculo }}</strong><br><small>{{ item.marca_modelo }}</small></td>
                        <td>{{ item.cuenta_sigfe }}<br><small>{{ item.nombre_cuenta }}</small></td>
                        <td>${{ item.monto_asignado|floatformat:0 }}</td>
                        <td>${{ item.monto_ejecutado|floatformat:0 }}</td>
                        <td>
                            {% if item.diferencia > 0 %}
                                <span class="text-danger">+${{ item.diferencia|floatformat:0 }}</span>
                            {% else %}
                                <span class="text-success">${{ item.diferencia|floatformat:0 }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if item.tiene_alerta %}
                                <span class="badge bg-danger">{{ item.porcentaje_variacion|floatformat:2 }}%</span>
                            {% else %}
                                <span class="badge bg-success">{{ item.porcentaje_variacion|floatformat:2 }}%</span>
                            {% endif %}
                        </td>
                        <td>{{ item.porcentaje_ejecutado|floatformat:2 }}%</td>
                        <td>
                            {% if item.tiene_alerta %}
                                <span class="badge bg-warning">⚠ Variación >10%</span>
                            {% else %}
                                <span class="badge bg-success">✓ Dentro del rango</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center">No hay datos para el año seleccionado.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="tab-pane fade {% if active_tab == 'dashboard' %}show active{% endif %}"
        id="dashboard" role="tabpanel">
        <h4>Análisis Visual de la Flota</h4>
        <div class="row mt-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">Costos Totales por Vehículo</div>
                    <div class="card-body">
                        <canvas id="chartCostosPorVehiculo"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">Desglose de Costos</div>
                    <div class="card-body">
                        <canvas id="chartDesgloseCostos"></canvas>
                        <p class="text-muted small mt-2">Selecciona un vehículo en el gráfico de barras para ver su desglose.</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">Días Fuera de Servicio por Vehículo</div>
                    <div class="card-body">
                        <canvas id="chartDiasFueraServicio"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

