{% extends 'base.html' %}

{% block title %}Reportes - Gestión de Flota{% endblock %}

{% block content %}
<h2 class="mb-4"><i class="bi bi-graph-up"></i> Reportes</h2>

<ul class="nav nav-tabs mb-4" id="reportesTab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="costos-tab" data-bs-toggle="tab" data-bs-target="#costos" type="button" role="tab">
            <i class="bi bi-cash-coin"></i> Costos
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="variacion-tab" data-bs-toggle="tab" data-bs-target="#variacion" type="button" role="tab">
            <i class="bi bi-cash-stack"></i> Variación Presupuestaria
        </button>
    </li>
</ul>

<div class="tab-content" id="reportesTabContent">
    <!-- Tab Costos -->
    <div class="tab-pane fade show active" id="costos" role="tabpanel">
        <div class="mb-3">
            <a href="?exportar=excel" class="btn btn-success">
                <i class="bi bi-file-earmark-excel"></i> Exportar a Excel
            </a>
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Vehículo</th>
                        <th>Costo Mantenimientos</th>
                        <th>Costo Combustible</th>
                        <th>Costo Arriendos</th>
                        <th>Costo Total</th>
                        <th>Costo por Km</th>
                        <th>Presupuesto</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in reporte %}
                    <tr>
                        <td><strong>{{ item.vehiculo.patente }}</strong></td>
                        <td>${{ item.costo_mantenimientos|floatformat:0 }}</td>
                        <td>${{ item.costo_combustible|floatformat:0 }}</td>
                        <td>${{ item.costo_arriendos|floatformat:0 }}</td>
                        <td><strong>${{ item.costo_total|floatformat:0 }}</strong></td>
                        <td>${{ item.costo_por_km|floatformat:2 }}</td>
                        <td>${{ item.presupuesto|floatformat:0 }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center">No hay datos disponibles.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Tab Variación Presupuestaria -->
    <div class="tab-pane fade" id="variacion" role="tabpanel">
        <form method="get" class="mb-3">
            <div class="row">
                <div class="col-md-4">
                    <label>Año</label>
                    <select name="anio" class="form-control">
                        {% for anio_opcion in anios_disponibles %}
                        <option value="{{ anio_opcion }}" {% if anio_opcion == anio %}selected{% endif %}>
                            {{ anio_opcion }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label>&nbsp;</label><br>
                    <button type="submit" class="btn btn-primary">Filtrar</button>
                </div>
            </div>
        </form>
        
        <div class="mb-3">
            <a href="?exportar=excel&tipo=variacion&anio={{ anio }}" class="btn btn-success">
                <i class="bi bi-file-earmark-excel"></i> Exportar a Excel
            </a>
        </div>
        
        {% if alertas_variacion %}
        <div class="alert alert-danger">
            <strong><i class="bi bi-exclamation-triangle"></i> {{ alertas_variacion|length }} alerta(s) de sobrepaso presupuestario >10%</strong>
            <p>Los siguientes presupuestos han sido excedidos en más del 10% del monto planificado.</p>
        </div>
        {% endif %}
        
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Vehículo</th>
                        <th>Cuenta SIGFE</th>
                        <th>Monto Asignado</th>
                        <th>Monto Ejecutado</th>
                        <th>Diferencia</th>
                        <th>% Variación</th>
                        <th>% Ejecutado</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in reporte_variacion %}
                    <tr {% if item.tiene_alerta %}class="table-warning"{% endif %}>
                        <td><strong>{{ item.vehiculo }}</strong><br><small>{{ item.marca_modelo }}</small></td>
                        <td>{{ item.cuenta_sigfe }}<br><small>{{ item.nombre_cuenta }}</small></td>
                        <td>${{ item.monto_asignado|floatformat:0 }}</td>
                        <td>${{ item.monto_ejecutado|floatformat:0 }}</td>
                        <td>
                            {% if item.diferencia > 0 %}
                                <span class="text-danger">+${{ item.diferencia|floatformat:0 }}</span>
                            {% else %}
                                <span class="text-success">${{ item.diferencia|floatformat:0 }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if item.tiene_alerta %}
                                <span class="badge bg-danger">{{ item.porcentaje_variacion|floatformat:2 }}%</span>
                            {% else %}
                                <span class="badge bg-success">{{ item.porcentaje_variacion|floatformat:2 }}%</span>
                            {% endif %}
                        </td>
                        <td>{{ item.porcentaje_ejecutado|floatformat:2 }}%</td>
                        <td>
                            {% if item.tiene_alerta %}
                                <span class="badge bg-warning">⚠ Variación >10%</span>
                            {% else %}
                                <span class="badge bg-success">✓ Dentro del rango</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center">No hay datos para el año seleccionado.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

